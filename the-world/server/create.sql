CREATE DATABASE the_world;
USE the_world;


ALTER DATABASE the_world SET PRIMARY REGION "us-east1";
ALTER DATABASE the_world ADD REGION "us-west1";
ALTER DATABASE the_world ADD REGION "europe-west1";

SET enable_super_regions = 'on';
ALTER DATABASE the_world ADD SUPER REGION "na" VALUES "us-east1", "us-west1";
ALTER DATABASE the_world ADD SUPER REGION "eu" VALUES "europe-west1";


CREATE TABLE connections (
  "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  "src" TEXT NOT NULL,
  "dest" TEXT NOT NULL
) LOCALITY REGIONAL BY ROW;

CREATE TABLE cells (
  "name" TEXT PRIMARY KEY,
  "smiley" TEXT NOT NULL
) LOCALITY REGIONAL BY ROW;

CREATE TABLE visits (
  "cell_name" TEXT NOT NULL,
  "timestamp" TIMESTAMPTZ NOT NULL DEFAULT now()
) LOCALITY REGIONAL BY ROW;


CREATE OR REPLACE FUNCTION user_to_db_region(region TEXT) RETURNS CRDB_INTERNAL_REGION IMMUTABLE LEAKPROOF LANGUAGE SQL AS $$
  SELECT CASE
    WHEN lower(region) = 'na' THEN 'us-east1'::CRDB_INTERNAL_REGION
    WHEN lower(region) = 'eu' THEN 'europe-west1'::CRDB_INTERNAL_REGION
    ELSE 'us-east1'::CRDB_INTERNAL_REGION
  END;
$$;

SELECT user_to_db_region('NA');
SELECT user_to_db_region('EU');

CREATE OR REPLACE FUNCTION db_to_user_region(region CRDB_INTERNAL_REGION) RETURNS STRING IMMUTABLE LEAKPROOF LANGUAGE SQL AS $$
  SELECT CASE
    WHEN region::STRING IN ('us-east', 'us-west') THEN 'NA'
    WHEN region::STRING = 'europe-west1' THEN 'EU'
    ELSE 'NA'
  END;
$$;

SELECT db_to_user_region('us-east1');
SELECT db_to_user_region('us-west1');
SELECT db_to_user_region('europe-west1');


CREATE USER world_service WITH PASSWORD 'EcSljwBeVIG42KLO0LS3jtuh9x6RMcOBZEWFSk';
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO world_service;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO world_service;


INSERT INTO connections (src, dest, crdb_region) VALUES
  ('eu17', 'eu11', 'europe-west1'),
  ('eu17', 'eu23', 'europe-west1'),
  ('eu17', 'eu16', 'europe-west1'),
  ('eu18', 'eu12', 'europe-west1'),
  ('eu18', 'eu24', 'europe-west1'),
  ('eu18', 'eu19', 'europe-west1'),
  ('na06', 'na00', 'us-east1'),
  ('na06', 'na12', 'us-east1'),
  ('na06', 'na07', 'us-east1'),
  ('na22', 'na16', 'us-east1'),
  ('na22', 'na28', 'us-east1'),
  ('na22', 'na21', 'us-east1'),
  ('na22', 'na23', 'us-east1'),
  ('na31', 'na25', 'us-east1'),
  ('na31', 'na30', 'us-east1'),
  ('na31', 'na32', 'us-east1'),
  ('na18', 'na12', 'us-east1'),
  ('na18', 'na24', 'us-east1'),
  ('na18', 'na19', 'us-east1'),
  ('na27', 'na21', 'us-east1'),
  ('na27', 'na33', 'us-east1'),
  ('na27', 'na26', 'us-east1'),
  ('na27', 'na28', 'us-east1'),
  ('na28', 'na22', 'us-east1'),
  ('na28', 'na34', 'us-east1'),
  ('na28', 'na27', 'us-east1'),
  ('na28', 'na29', 'us-east1'),
  ('eu09', 'eu03', 'europe-west1'),
  ('eu09', 'eu15', 'europe-west1'),
  ('eu09', 'eu08', 'europe-west1'),
  ('eu09', 'eu10', 'europe-west1'),
  ('eu14', 'eu08', 'europe-west1'),
  ('eu14', 'eu20', 'europe-west1'),
  ('eu14', 'eu13', 'europe-west1'),
  ('eu14', 'eu15', 'europe-west1'),
  ('eu16', 'eu10', 'europe-west1'),
  ('eu16', 'eu22', 'europe-west1'),
  ('eu16', 'eu15', 'europe-west1'),
  ('eu16', 'eu17', 'europe-west1'),
  ('eu32', 'eu26', 'europe-west1'),
  ('eu32', 'eu31', 'europe-west1'),
  ('eu32', 'eu33', 'europe-west1'),
  ('na11', 'na05', 'us-east1'),
  ('na11', 'na17', 'us-east1'),
  ('na11', 'na10', 'us-east1'),
  ('na11', 'eu00', 'europe-west1'),
  ('na11', 'eu06', 'europe-west1'),
  ('na11', 'eu12', 'europe-west1'),
  ('na13', 'na07', 'us-east1'),
  ('na13', 'na19', 'us-east1'),
  ('na13', 'na12', 'us-east1'),
  ('na13', 'na14', 'us-east1'),
  ('na29', 'na23', 'us-east1'),
  ('na29', 'na35', 'us-east1'),
  ('na29', 'na28', 'us-east1'),
  ('eu15', 'eu09', 'europe-west1'),
  ('eu15', 'eu21', 'europe-west1'),
  ('eu15', 'eu14', 'europe-west1'),
  ('eu15', 'eu16', 'europe-west1'),
  ('eu19', 'eu13', 'europe-west1'),
  ('eu19', 'eu25', 'europe-west1'),
  ('eu19', 'eu18', 'europe-west1'),
  ('eu19', 'eu20', 'europe-west1'),
  ('eu26', 'eu20', 'europe-west1'),
  ('eu26', 'eu32', 'europe-west1'),
  ('eu26', 'eu25', 'europe-west1'),
  ('eu26', 'eu27', 'europe-west1'),
  ('eu33', 'eu27', 'europe-west1'),
  ('eu33', 'eu32', 'europe-west1'),
  ('eu33', 'eu34', 'europe-west1'),
  ('eu35', 'eu29', 'europe-west1'),
  ('eu35', 'eu34', 'europe-west1'),
  ('na23', 'na17', 'us-east1'),
  ('na23', 'na29', 'us-east1'),
  ('na23', 'na22', 'us-east1'),
  ('eu10', 'eu04', 'europe-west1'),
  ('eu10', 'eu16', 'europe-west1'),
  ('eu10', 'eu09', 'europe-west1'),
  ('eu10', 'eu11', 'europe-west1'),
  ('eu11', 'eu05', 'europe-west1'),
  ('eu11', 'eu17', 'europe-west1'),
  ('eu11', 'eu10', 'europe-west1'),
  ('eu08', 'eu02', 'europe-west1'),
  ('eu08', 'eu14', 'europe-west1'),
  ('eu08', 'eu07', 'europe-west1'),
  ('eu08', 'eu09', 'europe-west1'),
  ('na07', 'na01', 'us-east1'),
  ('na07', 'na13', 'us-east1'),
  ('na07', 'na06', 'us-east1'),
  ('na07', 'na08', 'us-east1'),
  ('na16', 'na10', 'us-east1'),
  ('na16', 'na22', 'us-east1'),
  ('na16', 'na15', 'us-east1'),
  ('na16', 'na17', 'us-east1'),
  ('na20', 'na14', 'us-east1'),
  ('na20', 'na26', 'us-east1'),
  ('na20', 'na19', 'us-east1'),
  ('na20', 'na21', 'us-east1'),
  ('na24', 'na18', 'us-east1'),
  ('na24', 'na30', 'us-east1'),
  ('na24', 'na25', 'us-east1'),
  ('na26', 'na20', 'us-east1'),
  ('na26', 'na32', 'us-east1'),
  ('na26', 'na25', 'us-east1'),
  ('na26', 'na27', 'us-east1'),
  ('na33', 'na27', 'us-east1'),
  ('na33', 'na32', 'us-east1'),
  ('na33', 'na34', 'us-east1'),
  ('eu06', 'eu00', 'europe-west1'),
  ('eu06', 'eu12', 'europe-west1'),
  ('eu06', 'eu07', 'europe-west1'),
  ('eu06', 'na05', 'us-east1'),
  ('eu06', 'na11', 'us-east1'),
  ('eu20', 'eu14', 'europe-west1'),
  ('eu20', 'eu26', 'europe-west1'),
  ('eu20', 'eu19', 'europe-west1'),
  ('eu20', 'eu21', 'europe-west1'),
  ('na04', 'na10', 'us-east1'),
  ('na04', 'na03', 'us-east1'),
  ('na04', 'na05', 'us-east1'),
  ('na08', 'na02', 'us-east1'),
  ('na08', 'na14', 'us-east1'),
  ('na08', 'na07', 'us-east1'),
  ('na08', 'na09', 'us-east1'),
  ('na14', 'na08', 'us-east1'),
  ('na14', 'na20', 'us-east1'),
  ('na14', 'na13', 'us-east1'),
  ('na14', 'na15', 'us-east1'),
  ('eu25', 'eu19', 'europe-west1'),
  ('eu25', 'eu31', 'europe-west1'),
  ('eu25', 'eu24', 'europe-west1'),
  ('eu25', 'eu26', 'europe-west1'),
  ('na00', 'na06', 'us-east1'),
  ('na00', 'na01', 'us-east1'),
  ('na01', 'na07', 'us-east1'),
  ('na01', 'na00', 'us-east1'),
  ('na01', 'na02', 'us-east1'),
  ('eu07', 'eu01', 'europe-west1'),
  ('eu07', 'eu13', 'europe-west1'),
  ('eu07', 'eu06', 'europe-west1'),
  ('eu07', 'eu08', 'europe-west1'),
  ('eu05', 'eu11', 'europe-west1'),
  ('eu05', 'eu04', 'europe-west1'),
  ('na02', 'na08', 'us-east1'),
  ('na02', 'na01', 'us-east1'),
  ('na02', 'na03', 'us-east1'),
  ('na17', 'na11', 'us-east1'),
  ('na17', 'na23', 'us-east1'),
  ('na17', 'na16', 'us-east1'),
  ('na21', 'na15', 'us-east1'),
  ('na21', 'na27', 'us-east1'),
  ('na21', 'na20', 'us-east1'),
  ('na21', 'na22', 'us-east1'),
  ('na32', 'na26', 'us-east1'),
  ('na32', 'na31', 'us-east1'),
  ('na32', 'na33', 'us-east1'),
  ('na35', 'na29', 'us-east1'),
  ('na35', 'na34', 'us-east1'),
  ('na35', 'eu30', 'europe-west1'),
  ('eu29', 'eu23', 'europe-west1'),
  ('eu29', 'eu35', 'europe-west1'),
  ('eu29', 'eu28', 'europe-west1'),
  ('eu00', 'eu06', 'europe-west1'),
  ('eu00', 'eu01', 'europe-west1'),
  ('eu00', 'na05', 'us-east1'),
  ('eu00', 'na11', 'us-east1'),
  ('eu01', 'eu07', 'europe-west1'),
  ('eu01', 'eu00', 'europe-west1'),
  ('eu01', 'eu02', 'europe-west1'),
  ('eu04', 'eu10', 'europe-west1'),
  ('eu04', 'eu03', 'europe-west1'),
  ('eu04', 'eu05', 'europe-west1'),
  ('eu34', 'eu28', 'europe-west1'),
  ('eu34', 'eu33', 'europe-west1'),
  ('eu34', 'eu35', 'europe-west1'),
  ('na12', 'na06', 'us-east1'),
  ('na12', 'na18', 'us-east1'),
  ('na12', 'na13', 'us-east1'),
  ('na19', 'na13', 'us-east1'),
  ('na19', 'na25', 'us-east1'),
  ('na19', 'na18', 'us-east1'),
  ('na19', 'na20', 'us-east1'),
  ('na25', 'na19', 'us-east1'),
  ('na25', 'na31', 'us-east1'),
  ('na25', 'na24', 'us-east1'),
  ('na25', 'na26', 'us-east1'),
  ('na10', 'na04', 'us-east1'),
  ('na10', 'na16', 'us-east1'),
  ('na10', 'na09', 'us-east1'),
  ('na10', 'na11', 'us-east1'),
  ('na15', 'na09', 'us-east1'),
  ('na15', 'na21', 'us-east1'),
  ('na15', 'na14', 'us-east1'),
  ('na15', 'na16', 'us-east1'),
  ('eu02', 'eu08', 'europe-west1'),
  ('eu02', 'eu01', 'europe-west1'),
  ('eu02', 'eu03', 'europe-west1'),
  ('eu24', 'eu18', 'europe-west1'),
  ('eu24', 'eu30', 'europe-west1'),
  ('eu24', 'eu25', 'europe-west1'),
  ('eu12', 'eu06', 'europe-west1'),
  ('eu12', 'eu18', 'europe-west1'),
  ('eu12', 'eu13', 'europe-west1'),
  ('eu12', 'na11', 'us-east1'),
  ('eu21', 'eu15', 'europe-west1'),
  ('eu21', 'eu27', 'europe-west1'),
  ('eu21', 'eu20', 'europe-west1'),
  ('eu21', 'eu22', 'europe-west1'),
  ('eu30', 'eu24', 'europe-west1'),
  ('eu30', 'eu31', 'europe-west1'),
  ('eu30', 'na35', 'us-east1'),
  ('eu31', 'eu25', 'europe-west1'),
  ('eu31', 'eu30', 'europe-west1'),
  ('eu31', 'eu32', 'europe-west1'),
  ('na03', 'na09', 'us-east1'),
  ('na03', 'na02', 'us-east1'),
  ('na03', 'na04', 'us-east1'),
  ('na05', 'na11', 'us-east1'),
  ('na05', 'na04', 'us-east1'),
  ('na05', 'eu00', 'europe-west1'),
  ('na05', 'eu06', 'europe-west1'),
  ('na09', 'na03', 'us-east1'),
  ('na09', 'na15', 'us-east1'),
  ('na09', 'na08', 'us-east1'),
  ('na09', 'na10', 'us-east1'),
  ('eu23', 'eu17', 'europe-west1'),
  ('eu23', 'eu29', 'europe-west1'),
  ('eu23', 'eu22', 'europe-west1'),
  ('eu27', 'eu21', 'europe-west1'),
  ('eu27', 'eu33', 'europe-west1'),
  ('eu27', 'eu26', 'europe-west1'),
  ('eu27', 'eu28', 'europe-west1'),
  ('eu28', 'eu22', 'europe-west1'),
  ('eu28', 'eu34', 'europe-west1'),
  ('eu28', 'eu27', 'europe-west1'),
  ('eu28', 'eu29', 'europe-west1'),
  ('na34', 'na28', 'us-east1'),
  ('na34', 'na33', 'us-east1'),
  ('na34', 'na35', 'us-east1'),
  ('eu13', 'eu07', 'europe-west1'),
  ('eu13', 'eu19', 'europe-west1'),
  ('eu13', 'eu12', 'europe-west1'),
  ('eu13', 'eu14', 'europe-west1'),
  ('eu22', 'eu16', 'europe-west1'),
  ('eu22', 'eu28', 'europe-west1'),
  ('eu22', 'eu21', 'europe-west1'),
  ('eu22', 'eu23', 'europe-west1'),
  ('na30', 'na24', 'us-east1'),
  ('na30', 'na31', 'us-east1'),
  ('eu03', 'eu09', 'europe-west1'),
  ('eu03', 'eu02', 'europe-west1'),
  ('eu03', 'eu04', 'europe-west1');